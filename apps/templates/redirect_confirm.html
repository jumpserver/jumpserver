{% extends '_base_only_content.html' %}
{% load static %}
{% load i18n %}
{% block html_title %} {{ INTERFACE.login_title }} {% endblock %}
{% block title %} {{ INTERFACE.login_title }}{% endblock %}

{% block content %}
    <style>
        .target-url {
            display: inline-block;
            max-width: 100%;
            min-width: 100px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: middle;
            cursor: pointer;
        }

        /* 重定向中的样式 */
        .redirecting-container {
            display: none;
        }

        .redirecting-container.show {
            display: block;
        }

        .confirm-container {
            transition: opacity 0.3s ease-out;
        }

        .confirm-container.hide {
            display: none;
        }
    </style>
    <div>
        <!-- 确认内容 -->
        <div class="confirm-container" id="confirmContainer">
            <p>
            <div class="alert {% if error %} alert-danger {% else %} alert-info {% endif %}" id="messages">
                {% trans 'You are about to be redirected to an external website.' %}
                <br/>
                <br/>
                {% trans 'Please confirm that you trust this link: ' %}
                <br/>
                <br/>
                <a class="target-url" href="javascript:void(0)" onclick="handleRedirect(event)">{{ target_url }}</a>
            </div>
            </p>

            <div class="row">
                <div class="col-sm-3">
                    <a href="/" class="btn btn-default block full-width m-b">
                        {% trans 'Back' %}
                    </a>
                </div>
                <div class="col-sm-3">
                    <a href="javascript:void(0)" onclick="handleRedirect(event)" class="btn btn-primary block full-width m-b">
                        {% trans 'Confirm' %}
                    </a>
                </div>
            </div>
        </div>

        <!-- 重定向中内容 -->
        <div class="redirecting-container" id="redirectingContainer">
            <p>
                <div class="alert alert-info" id="messages">
                    {% trans 'Redirecting you to the Desktop App ( JumpServer Client )' %}
                    <br/>
                    <br/>
                    {% trans 'You can safely close this window and return to the application.' %}
                </div>
            </p>
        </div>
    </div>


    <script>
        const targetUrl = '{{ target_url }}';

        // 判断是否是 jms:// 协议
        function isJmsProtocol(url) {
            return url.toLowerCase().startsWith('jms://');
        }

        function handleRedirect(event) {
            // 如果有 event，阻止默认行为
            if (event) {
                event.preventDefault();
            }

            if (isJmsProtocol(targetUrl)) {
                // 隐藏确认内容
                document.getElementById('confirmContainer').classList.add('hide');
                // 显示重定向中
                document.getElementById('redirectingContainer').classList.add('show');
            }

            // 延迟后执行跳转（让用户看到加载动画）
            setTimeout(() => {
                window.location.href = targetUrl;
            }, 100);
        }
    </script>
{% endblock %}



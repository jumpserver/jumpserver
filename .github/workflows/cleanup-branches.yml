name: Cleanup PR Branches

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      dry_run:
        description: 'Dry run mode (default: true)'
        required: false
        default: 'true'
        type: boolean

jobs:
  cleanup-branches:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–æ‰€æœ‰åˆ†æ”¯å’Œæäº¤åŽ†å²
        
    - name: Setup Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
    - name: Get dry run setting
      id: dry-run
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "dry_run=${{ github.event.inputs.dry_run }}" >> $GITHUB_OUTPUT
        else
          echo "dry_run=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Cleanup branches
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        DRY_RUN: ${{ steps.dry-run.outputs.dry_run }}
      run: |
        echo "Starting branch cleanup..."
        echo "Dry run mode: $DRY_RUN"
        
        # èŽ·å–æ‰€æœ‰æœ¬åœ°åˆ†æ”¯
        git fetch --all --prune
        
        # èŽ·å–ä»¥ pr æˆ– repr å¼€å¤´çš„åˆ†æ”¯
        branches=$(git branch -r | grep -E 'origin/(pr|repr)' | sed 's/origin\///' | grep -v 'HEAD')
        
        echo "Found branches matching pattern:"
        echo "$branches"
        
        deleted_count=0
        skipped_count=0
        
        for branch in $branches; do
          echo ""
          echo "Processing branch: $branch"
          
          # æ£€æŸ¥åˆ†æ”¯æ˜¯å¦æœ‰æœªåˆå¹¶çš„PR
          pr_info=$(gh pr list --head "$branch" --state open --json number,title,state 2>/dev/null)
          
          if [ $? -eq 0 ] && [ "$pr_info" != "[]" ]; then
            echo "  âš ï¸  Branch has open PR(s), skipping deletion"
            echo "  PR info: $pr_info"
            skipped_count=$((skipped_count + 1))
            continue
          fi
          
          # æ£€æŸ¥åˆ†æ”¯æ˜¯å¦æœ‰å·²åˆå¹¶çš„PRï¼ˆå¯é€‰ï¼šå¦‚æžœPRå·²åˆå¹¶ä¹Ÿå¯ä»¥åˆ é™¤ï¼‰
          merged_pr_info=$(gh pr list --head "$branch" --state merged --json number,title,state 2>/dev/null)
          
          if [ $? -eq 0 ] && [ "$merged_pr_info" != "[]" ]; then
            echo "  âœ… Branch has merged PR(s), safe to delete"
            echo "  Merged PR info: $merged_pr_info"
          else
            echo "  â„¹ï¸  No PRs found for this branch"
          fi
          
          # æ‰§è¡Œåˆ é™¤æ“ä½œ
          if [ "$DRY_RUN" = "true" ]; then
            echo "  ðŸ” [DRY RUN] Would delete branch: $branch"
            deleted_count=$((deleted_count + 1))
          else
            echo "  ðŸ—‘ï¸  Deleting branch: $branch"
            
            # åˆ é™¤è¿œç¨‹åˆ†æ”¯
            if git push origin --delete "$branch" 2>/dev/null; then
              echo "  âœ… Successfully deleted remote branch: $branch"
              deleted_count=$((deleted_count + 1))
            else
              echo "  âŒ Failed to delete remote branch: $branch"
            fi
          fi
        done
        
        echo ""
        echo "=== Cleanup Summary ==="
        echo "Branches processed: $(echo "$branches" | wc -l)"
        echo "Branches deleted: $deleted_count"
        echo "Branches skipped: $skipped_count"
        
        if [ "$DRY_RUN" = "true" ]; then
          echo ""
          echo "ðŸ” This was a DRY RUN - no branches were actually deleted"
          echo "To perform actual deletion, run this workflow manually with dry_run=false"
        fi
        
    - name: Create summary
      if: always()
      run: |
        echo "## Branch Cleanup Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
        echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "**Dry Run:** ${{ steps.dry-run.outputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Check the logs above for detailed information about processed branches." >> $GITHUB_STEP_SUMMARY
